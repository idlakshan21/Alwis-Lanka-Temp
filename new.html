<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pawning Receipt System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .input-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      align-items: center;
    }

    input {
      padding: 8px;
      width: 70%;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    #loading {
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    #receipts {
      margin-top: 20px;
    }

    .receipt-page {
      width: 8.3in;
      height: 5.3in;
      border: 1px solid #ddd;
      padding: 0.3in;
      margin-bottom: 30px;
      background-color: white;
      page-break-after: always;
      position: relative;
      overflow: hidden;
    }

    /* Background watermark */
    .receipt-page:before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><text x="50" y="100" font-family="Arial" font-size="40" font-weight="bold" fill="rgba(200,200,200,0.2)" transform="rotate(-45 100 100)">ALWIS LANKA</text></svg>') center/30% repeat;
      z-index: 0;
      opacity: 0.1;
    }

    .receipt-content {
      position: relative;
      z-index: 1;
    }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px dashed #ccc;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }

    .receipt-logo-section {
      display: flex;
      align-items: center;
      width: 60%;
    }

    .logo-circle {
      width: 60px;
      height: 60px;
      border: 2px solid #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 24px;
    }

    .receipt-logo-text {
      display: flex;
      flex-direction: column;
    }

    .receipt-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .receipt-subtitle {
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .receipt-address {
      width: 35%;
      text-align: right;
      font-size: 12px;
    }

    .receipt-ticket {
      border: 1px solid #000;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      width: 30%;
      margin: 10px auto;
    }

    .receipt-ticket h3 {
      font-size: 14px;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .main-content {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .customer-section {
      width: 48%;
      border: 1px solid #000;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      min-height: 140px;
    }

    .items-section {
      width: 48%;
      border: 1px solid #000;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      min-height: 140px;
    }

    .customer-section-title, .items-section-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 12px;

      padding-bottom: 5px;
    }

    .customer-info-row {
      margin-bottom: 5px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .items-table th, .items-table td {
     
      padding: 4px;
    }

    .items-table th {
    
      text-align: center;
    }

    .bottom-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .amount-section, .period-section, .redemption-section {
      width: 30%;
      border: 1px solid #000;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
      min-height: 60px;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .disclaimer {
      font-size: 8px;
      margin-top: 15px;
      margin-bottom: 15px;
      text-align: justify;
    }

    .signature-section {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 30px;
    }

    .signature-box {
      width: 30%;
      text-align: center;
    }

    .signature-line {
      margin-top: 40px;
      border-top: 1px solid #000;
      padding-top: 5px;
    }

    .page-number {
      text-align: right;
      margin-top: 10px;
      font-size: 10px;
    }

    @media print {
      body {
        background-color: white;
        padding: 0;
      }

      .container {
        max-width: 100%;
        box-shadow: none;
        padding: 0;
      }

      .input-section, .btn-section, #print-btn {
        display: none;
      }

      .receipt-page {
        border: none;
        margin-bottom: 0;
      }

      button.print-hide {
        display: none;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Pawning Receipt System</h1>
  </div>

  <div class="input-section">
    <input type="number" id="customer-id" placeholder="Enter Customer ID">
    <button id="generate-btn">Generate Receipt</button>
  </div>

  <div class="btn-section">
    <button id="print-btn">Print All Receipts</button>
  </div>

  <div id="loading">Loading...</div>

  <div id="receipts"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-btn');
    const printBtn = document.getElementById('print-btn');
    const customerIdInput = document.getElementById('customer-id');
    const receiptsContainer = document.getElementById('receipts');
    const loadingIndicator = document.getElementById('loading');

    generateBtn.addEventListener('click', generateReceipts);
    printBtn.addEventListener('click', printReceipts);

    // Default customer ID for testing
    customerIdInput.value = 2;

    async function generateReceipts() {
      const customerId = customerIdInput.value.trim();

      if (!customerId) {
        alert('Please enter a Customer ID');
        return;
      }

      receiptsContainer.innerHTML = '';
      loadingIndicator.style.display = 'block';

      try {
        const data = await fetchTicketData(customerId);
        if (data && data.data && data.data.length > 0) {
          createReceiptPages(data.data);
        } else {
          receiptsContainer.innerHTML = '<p>No data found for this customer.</p>';
        }
      } catch (error) {
        console.error('Error:', error);
        receiptsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    async function fetchTicketData(customerId) {
      try {
        const response = await fetch(`http://localhost:8080/api/v1/ticket/lastTicket/`);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    function createReceiptPages(items) {
      // Calculate number of pages needed (2 items per page)
      const itemsPerPage = 2;
      const totalPages = Math.ceil(items.length / itemsPerPage);

      for (let page = 0; page < totalPages; page++) {
        // Get items for this page
        const startIdx = page * itemsPerPage;
        const pageItems = items.slice(startIdx, startIdx + itemsPerPage);

        // Create page element
        const pageElement = document.createElement('div');
        pageElement.className = 'receipt-page';

        // Add page content
        pageElement.innerHTML = createPageContent(pageItems, page + 1, totalPages, items);

        // Add to container
        receiptsContainer.appendChild(pageElement);
      }
    }

    function createPageContent(items, pageNumber, totalPages, allItems) {
    // Extract customer info from first item (all items should have the same customer info)
    const customerInfo = items[0];

    // Calculate totals
    const pageTotalLoan = items.reduce((sum, item) => sum + item.loanAmount, 0);
    const pageTotalInterest = items.reduce((sum, item) => sum + item.interestAmount, 0);
    const pageTotalWeight = items.reduce((sum, item) => sum + item.netWeight, 0);

    // Calculate grand totals
    const grandTotalLoan = allItems.reduce((sum, item) => sum + item.loanAmount, 0);
    const grandTotalInterest = allItems.reduce((sum, item) => sum + item.interestAmount, 0);
    const grandTotalWeight = allItems.reduce((sum, item) => sum + item.netWeight, 0);

    // Format the date for display
    const createdDate = formatDate(customerInfo.createdDate);
    const expiryDate = formatDate(customerInfo.expiryDate);

    let html = `
    <div class="receipt-content">
      <div class="receipt-header">
        <div class="receipt-logo-section">
          <div class="logo-circle"></div>
          <div class="receipt-logo-text">
            <div class="receipt-title"></div>
            <div class="receipt-subtitle"></div>
          </div>
        </div>
        <div class="receipt-address">
          <p></p>
          <p></p>
          <p></p>
          <p></p>
        </div>
      </div>

      <div class="receipt-info">
        <div class="date" style="position: absolute; left: 40mm; top: 30mm;">${createdDate}</div>
        <div class="bill-no" style="position: absolute; left: 40mm; top: 40mm;">${customerInfo.ticketNo}</div>
        <div class="time" style="position: absolute; left: 160mm; top: 40mm;">T ${new Date().toLocaleTimeString()}</div>
      </div>

      <div class="main-content">
        <div class="customer-section">
          <div class="name-address" style="position: absolute; left: 20mm; top: 58mm;">
            <div><strong>${customerInfo.customerName}</strong></div>
            <div>${customerInfo.customerAddressOne}${customerInfo.customerAddressTwo ? ', ' + customerInfo.customerAddressTwo : ''}</div>
          </div>
          <div class="nic" style="position: absolute; left: 60mm; top: 75mm;">${customerInfo.customerNic}</div>
          <div class="tel-no" style="position: absolute; left: 60mm; top: 82mm;">
            ${customerInfo.customerContactOne}${customerInfo.customerContactTwo ? ', ' + customerInfo.customerContactTwo : ''}
          </div>
        </div>

        <div class="items-section" style="position: absolute; left: 103mm; top: 58mm;">
          <div class="items-table">
            <div class="items-header">
              <div class="item-col" style="position: absolute; left: 0mm; top: 0mm;">Item</div>
              <div class="weight-col" style="position: absolute; left: 22mm; top: 0mm;">Weight</div>
              <div class="gold-content-col" style="position: absolute; left: 42mm; top: 0mm;">Gold Content</div>
            </div>
            <div class="items-body">
    `;

    // Add items for this page
    items.forEach((item, index) => {
        html += `
              <div class="item-row" style="position: absolute; left: 0mm; top: ${(index + 1) * 7}mm;">
                <div class="item-col" style="position: absolute; left: 0mm;">${item.article} (${item.note})</div>
                <div class="weight-col" style="position: absolute; left: 22mm;">${item.netWeight} g</div>
                <div class="gold-content-col" style="position: absolute; left: 42mm;">${item.karatValue}</div>
              </div>
        `;
    });

    html += `
              <div class="total-weight" style="position: absolute; left: 42mm; top: ${(items.length + 1) * 7}mm;">
                <strong>${formatNumber(pageTotalWeight)} Grams</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-section">
        <div class="amount-section" style="position: absolute; left: 40mm; top: 90mm;">
          <div>Loan: ${formatCurrency(pageTotalLoan)}</div>
          <div>Interest: ${formatCurrency(pageTotalInterest)}</div>
          <div><strong>Total: ${formatCurrency(pageTotalLoan + pageTotalInterest)}</strong></div>
        </div>

        <div class="period-section" style="position: absolute; left: 95mm; top: 90mm;">
          <div>${customerInfo.monthlyInterest}% monthly</div>
          <div>${customerInfo.dailyInterest}%</div>
          <div>12 months</div>
        </div>

        <div class="redemption-section" style="position: absolute; left: 170mm; top: 90mm;">
          <div><strong>${expiryDate}</strong></div>
        </div>

        <div class="gold-loan-advance" style="position: absolute; left: 40mm; top: 100mm;">
          <div>Gold Loan Advance: ${formatCurrency(pageTotalLoan)}</div>
        </div>
      </div>

      <div class="disclaimer">
      </div>

      <div class="signature-section">
        <div class="signature-box">
          <div class="signature-line"></div>
        </div>
        <div class="signature-box">
          <div class="signature-line"></div>
        </div>
        <div class="signature-box">
          <div class="signature-line"></div>
        </div>
      </div>

      <div class="page-number">
        ${pageNumber} of ${totalPages}
      </div>
    </div>
    `;

    return html;
}

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function formatCurrency(amount) {
      return amount.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatNumber(num) {
      return num.toLocaleString('en-US', {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      });
    }

    function printReceipts() {
      window.print();
    }
  });
</script>
</body>
</html>
